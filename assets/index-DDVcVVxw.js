(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function r(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=r(s);fetch(s.href,o)}})();const $=.9,pe={0:[[[.1,.1],[.1,.9]],[[.1,.9],[.7,.9]],[[.7,.9],[.7,.1]],[[.7,.1],[.1,.1]]],1:[[[.4,.1],[.4,.9]]],2:[[[.1,.9],[.7,.9]],[[.7,.9],[.7,.5]],[[.7,.5],[.1,.5]],[[.1,.5],[.1,.1]],[[.1,.1],[.7,.1]]],3:[[[.1,.9],[.7,.9]],[[.7,.9],[.7,.1]],[[.1,.1],[.7,.1]],[[.1,.5],[.7,.5]]],4:[[[.1,.9],[.1,.5]],[[.1,.5],[.7,.5]],[[.7,.9],[.7,.1]]],5:[[[.7,.9],[.1,.9]],[[.1,.9],[.1,.5]],[[.1,.5],[.7,.5]],[[.7,.5],[.7,.1]],[[.1,.1],[.7,.1]]],6:[[[.7,.9],[.1,.9]],[[.1,.9],[.1,.1]],[[.1,.1],[.7,.1]],[[.7,.1],[.7,.5]],[[.1,.5],[.7,.5]]],7:[[[.1,.9],[.7,.9]],[[.7,.9],[.7,.1]]],8:[[[.1,.1],[.1,.9]],[[.7,.1],[.7,.9]],[[.1,.1],[.7,.1]],[[.1,.5],[.7,.5]],[[.1,.9],[.7,.9]]],9:[[[.1,.9],[.7,.9]],[[.1,.5],[.7,.5]],[[.7,.9],[.7,.1]],[[.1,.9],[.1,.5]]],".":[[[.3,.1],[.5,.1]]],"-":[[[.1,.5],[.7,.5]]]},te=String.raw`M73 P0 R19
M73 Q0 S21
M201 X10000 Y10000 Z400 E5000 ; sets maximum accelerations, mm/sec^2
M203 X350 Y350 Z12 E100 ; sets maximum feedrates, mm / sec
M204 P7000 R2500 T7000 ; sets acceleration (P, T) and retract acceleration (R), mm/sec^2
M205 X10.00 Y10.00 Z2.00 E10.00 ; sets the jerk limits, mm/sec
M205 S0 T0 ; sets the minimum extruding and travel feed rate, mm/sec

M486 S0
M486 AShape-Box
M486 S-1

;TYPE:Custom
M17 ; enable steppers
M862.1 P0.4 A0 F1 ; nozzle check
M862.3 P "COREONE" ; printer model check
M862.5 P2 ; g-code level check
M862.6 P"Input shaper" ; FW feature check
M115 U6.3.4+10511

M555 X112.5 Y93.5 W32 H29

G90 ; use absolute coordinates
M83 ; extruder relative mode

M140 S[bed_temperature] ; set bed temp

M109 R170 ; wait for temp

M84 E ; turn off E motor

G28 ; home all without mesh bed level

M141 S20 ; set nominal chamber temp

M106 S70
G0 Z40 F10000
M104 T0 S170
M190 R[bed_temperature] ; wait for bed temp
M107

G29 G ; absorb heat

M109 R170 ; wait for MBL temp

M302 S155 ; lower cold extrusion limit to 155C

G1 E-2 F2400 ; retraction

M84 E ; turn off E motor

G29 P9 X208 Y-2.5 W32 H4

;
; MBL
;
M84 E ; turn off E motor
G29 P1 ; invalidate mbl & probe print area
G29 P1 X150 Y0 W100 H20 C ; probe near purge place
G29 P3.2 ; interpolate mbl probes
G29 P3.13 ; extrapolate mbl outside probe area
G29 A ; activate mbl

; prepare for purge
M104 S[hotend_temperature]
G0 X249 Y-2.5 Z15 F4800 ; move away and ready for the purge
M109 S[hotend_temperature]

G92 E0
M569 S0 E ; set spreadcycle mode for extruder

M591 S0 ; disable stuck detection

;
; Extrude purge line
;
G92 E0 ; reset extruder position
G1 E2 F2400 ; deretraction after the initial one
G0 E5 X235 Z0.2 F500 ; purge
G0 X225 E4 F500 ; purge
G0 X215 E4 F650 ; purge
G0 X205 E4 F800 ; purge
G0 X202 Z0.05 F8000 ; wipe, move close to the bed
M73 P1 R19
G0 X199 Z0.2 F8000 ; wipe, move quickly away from the bed

M591 R ; restore stuck detection

G92 E0
M221 S100 ; set flow to 100%
G21 ; set units to millimeters
G90 ; use absolute coordinates
M83 ; use relative distances for extrusion
M572 S0.036 ; Filament gcode

M142 S36 ; set heatbreak target temp
M107`,ne=String.raw`M107
;TYPE:Custom
; Filament-specific end gcode
G1 Z26 F720 ; Move print head up
M104 S0 ; turn off temperature
M140 S0 ; turn off heatbed
M141 S0 ; disable chamber control
M107 ; turn off fan
G1 X242 Y211 F10200 ; park
G4 ; wait
M572 S0 ; reset PA
M84 X Y E ; disable motors
; max_layer_z = 25
M73 P100 R0
M73 Q100 S0`;function q(t,e,r){if(t<=1)return[e];const n=(r-e)/(t-1),s=[];for(let o=0;o<t;o++)s.push(e+o*n);return s}function ce(t){const e=t/2;return Math.PI*e*e}function _e(t,e,r){return t*e*.95/r}function me(t,e,r,n){if(t!=null&&(t<0||t>r))throw new Error(`G-code X move ${t.toFixed(3)} is outside bed [0, ${r}]`);if(e!=null&&(e<0||e>n))throw new Error(`G-code Y move ${e.toFixed(3)} is outside bed [0, ${n}]`)}function f({x:t=null,y:e=null,z:r=null,e:n=null,f:s=null,bedX:o,bedY:a}){me(t,e,o,a);const d=["G1"];return t!=null&&d.push(`X${t.toFixed(3)}`),e!=null&&d.push(`Y${e.toFixed(3)}`),r!=null&&d.push(`Z${r.toFixed(3)}`),n!=null&&d.push(`E${n.toFixed(5)}`),s!=null&&d.push(`F${s.toFixed(0)}`),d.join(" ")}function Q(t,e,r){return t.replace(/\[bed_temperature\]/g,String(e)).replace(/\[hotend_temperature\]/g,String(r))}function Se(t,e,r=0,n=0,s=150){const o=e*60,a=s*60,d=[`G1 E${(-t).toFixed(5)} F${o.toFixed(0)}`];if(r>0){const p=n+r;d.push(`G1 Z${p.toFixed(3)} F${a.toFixed(0)} ; z-hop up`)}const A=[];return r>0&&A.push(`G1 Z${n.toFixed(3)} F${a.toFixed(0)} ; z-hop down`),A.push(`G1 E${t.toFixed(5)} F${o.toFixed(0)}`),{retract:d.join(`
`),deretract:A.join(`
`)}}function Z(t,e,r=0,n=0,s=150){const o=e*60,a=s*60,d=t,A=[`G1 E${(-d).toFixed(5)} F${o.toFixed(0)}`];if(r>0){const c=n+r;A.push(`G1 Z${c.toFixed(3)} F${a.toFixed(0)} ; z-hop up`)}const p=[];return r>0&&p.push(`G1 Z${n.toFixed(3)} F${a.toFixed(0)} ; z-hop down`),p.push(`G1 E${d.toFixed(5)} F${o.toFixed(0)}`),{retract:A.join(`
`),deretract:p.join(`
`)}}function he(){const t=new Date,e=n=>n.toString().padStart(2,"0");return`retraction_doe_test_${`${t.getFullYear()}${e(t.getMonth()+1)}${e(t.getDate())}_${e(t.getHours())}${e(t.getMinutes())}`}.gcode`}function Te(t){const e={BED_SIZE_X:t.bedX,BED_SIZE_Y:t.bedY,MIN_RETRACT_DIST:t.minDist,MAX_RETRACT_DIST:t.maxDist,MIN_RETRACT_SPEED:t.minSpeed,MAX_RETRACT_SPEED:t.maxSpeed,ROWS:t.rows,COLS:t.cols,LINES_PER_PARAM:t.linesPerParam,NUM_DOE_LAYERS:t.numLayers,SEGMENT_LENGTH:t.segLen,TRAVEL_LENGTH:t.travelLen,Z_HOP:t.zHop||0,FLOW_FACTOR:t.flowFactor,BED_TEMP:t.bedTemp,HOTEND_TEMP:t.hotendTemp,FIRST_LAYER_FAN_SPEED:t.firstLayerFanSpeed,FAN_SPEED:t.fanSpeed,FIRST_LAYER_SPEED:t.firstLayerSpeed,PRINT_SPEED:t.printSpeed,TRAVEL_SPEED:t.travelSpeed,PRINT_ACCEL:t.printAccel,RETRACT_ACCEL:t.retractAccel,TRAVEL_ACCEL:t.travelAccel,FIRST_LAYER_PRINT_ACCEL:t.firstLayerPrintAccel,LAYER_HEIGHT:t.layerHeight,FIRST_LAYER_Z:t.firstLayerZ,TEXT_PRINT_SPEED:t.textSpeed,ROW_FONT_SIZE:t.rowFontSize,SPEED_FONT_SIZE:t.speedFontSize,EXTRUSION_WIDTH:t.extrusionWidth,FILAMENT_DIAMETER:1.75,ROW_GAP:t.rowGap,MARGIN:t.margin,DIST_LABEL_PAD:t.distLabelPad,PRESSURE_ADVANCE:t.pressureAdvance};e.FILAMENT_AREA=ce(e.FILAMENT_DIAMETER);const r=_e(e.EXTRUSION_WIDTH,e.LAYER_HEIGHT,e.FILAMENT_AREA);e.E_PER_MM=r*e.FLOW_FACTOR,e.AVG_RETRACT_DIST=.5*(e.MIN_RETRACT_DIST+e.MAX_RETRACT_DIST),e.AVG_RETRACT_SPEED=.5*(e.MIN_RETRACT_SPEED+e.MAX_RETRACT_SPEED);const n=[];n.push("; ========================================"),n.push("; Retraction DOE Test"),n.push("; Generated by retraction_doe_generator"),n.push("; ========================================"),n.push(";"),n.push("; === Printer Settings ==="),n.push(`; Bed size: ${e.BED_SIZE_X} x ${e.BED_SIZE_Y} mm`),n.push(`; Bed temperature: ${e.BED_TEMP}°C`),n.push(`; Hotend temperature: ${e.HOTEND_TEMP}°C`),n.push(`; Filament diameter: ${e.FILAMENT_DIAMETER} mm`),n.push(";"),n.push("; === Retraction Test Parameters ==="),n.push(`; Retraction distance (min): ${e.MIN_RETRACT_DIST} mm`),n.push(`; Retraction distance (max): ${e.MAX_RETRACT_DIST} mm`),n.push(`; Retraction speed (min): ${e.MIN_RETRACT_SPEED} mm/s`),n.push(`; Retraction speed (max): ${e.MAX_RETRACT_SPEED} mm/s`),n.push(`; DOE grid: ${e.ROWS} rows x ${e.COLS} columns`),n.push(`; Lines per parameter: ${e.LINES_PER_PARAM}`),n.push(";"),n.push("; === Speed & Acceleration ==="),n.push(`; First layer speed: ${e.FIRST_LAYER_SPEED} mm/s`),n.push(`; Print speed: ${e.PRINT_SPEED} mm/s`),n.push(`; Travel speed: ${e.TRAVEL_SPEED} mm/s`),n.push(`; Text speed: ${e.TEXT_SPEED} mm/s`),n.push(`; Print acceleration: ${e.PRINT_ACCEL} mm/s²`),n.push(`; Retract acceleration: ${e.RETRACT_ACCEL} mm/s²`),n.push(`; Travel acceleration: ${e.TRAVEL_ACCEL} mm/s²`),Number.isFinite(e.FIRST_LAYER_PRINT_ACCEL)&&n.push(`; First layer print acceleration: ${e.FIRST_LAYER_PRINT_ACCEL} mm/s²`),n.push(";"),n.push("; === Layer Settings ==="),n.push(`; First layer Z: ${e.FIRST_LAYER_Z} mm`),n.push(`; Layer height: ${e.LAYER_HEIGHT} mm`),n.push(`; Number of DOE layers: ${e.NUM_DOE_LAYERS}`),n.push(`; Z-hop: ${e.Z_HOP} mm`),n.push(";"),n.push("; === Extrusion Settings ==="),n.push(`; Extrusion width: ${e.EXTRUSION_WIDTH} mm`),n.push(`; Flow factor: ${e.FLOW_FACTOR.toFixed(3)}`),Number.isFinite(e.PRESSURE_ADVANCE)&&n.push(`; Pressure advance: ${e.PRESSURE_ADVANCE}`),n.push(";"),n.push("; === Fan Settings ==="),n.push(`; First layer fan speed: ${e.FIRST_LAYER_FAN_SPEED}%`),n.push(`; Normal fan speed: ${e.FAN_SPEED}%`),n.push(";"),n.push("; === Pattern Geometry ==="),n.push(`; Segment length: ${e.SEGMENT_LENGTH} mm`),n.push(`; Travel length: ${e.TRAVEL_LENGTH} mm`),n.push(`; Row gap: ${e.ROW_GAP} mm`),n.push(`; Margin: ${e.MARGIN} mm`),n.push(`; Distance label padding: ${e.DIST_LABEL_PAD} mm`),n.push(`; Row font size: ${e.ROW_FONT_SIZE} mm`),n.push(`; Speed font size: ${e.SPEED_FONT_SIZE} mm`),n.push(";"),n.push("; ========================================"),n.push("");const s=t.startGcode||te,o=t.endGcode||ne,a=Q(s,e.BED_TEMP,e.HOTEND_TEMP).trim(),d=Q(o,e.BED_TEMP,e.HOTEND_TEMP).trim();if(a){if(n.push(a),n.push(""),Number.isFinite(e.PRESSURE_ADVANCE)){const y=e.PRESSURE_ADVANCE;n.push(`pressure_advance = ${y}`),n.push(`M572 S${y}`),n.push("")}let P=e.FIRST_LAYER_PRINT_ACCEL!==null&&e.FIRST_LAYER_PRINT_ACCEL!==void 0?e.FIRST_LAYER_PRINT_ACCEL:e.PRINT_ACCEL;const D=Number.isFinite(e.RETRACT_ACCEL)?e.RETRACT_ACCEL:"",x=Number.isFinite(e.TRAVEL_ACCEL)?e.TRAVEL_ACCEL:"";if((Number.isFinite(P)||D!==""||x!=="")&&(n.push(`M204 P${P} R${D} T${x}`),n.push("")),Number.isFinite(e.FIRST_LAYER_FAN_SPEED)){const y=Math.round(e.FIRST_LAYER_FAN_SPEED/100*255);n.push(`M106 S${y} ; First layer fan speed ${e.FIRST_LAYER_FAN_SPEED}%`),n.push("")}}const A=q(e.ROWS,e.MIN_RETRACT_DIST,e.MAX_RETRACT_DIST),p=q(e.COLS,e.MIN_RETRACT_SPEED,e.MAX_RETRACT_SPEED),c=e.COLS*(e.SEGMENT_LENGTH+e.TRAVEL_LENGTH)+e.SEGMENT_LENGTH,_=e.LINES_PER_PARAM*e.EXTRUSION_WIDTH+e.ROW_GAP,u=e.ROWS*_-e.ROW_GAP+e.EXTRUSION_WIDTH,I=1,F=1;let h=0;A.forEach(P=>{const D=(P.toFixed(2)+"mm").length*$*e.ROW_FONT_SIZE;D>h&&(h=D)});const b=h+I+e.DIST_LABEL_PAD,L=Math.max(e.MARGIN,e.SPEED_FONT_SIZE+F),m=b+c+e.MARGIN,T=L+u;if(m>e.BED_SIZE_X+1e-6||T>e.BED_SIZE_Y+1e-6)throw new Error(`Pattern+labels too big for bed: needs ${m.toFixed(2)} x ${T.toFixed(2)} mm, bed is ${e.BED_SIZE_X.toFixed(2)} x ${e.BED_SIZE_Y.toFixed(2)} mm`);const S=(e.BED_SIZE_X-m)/2,l=(e.BED_SIZE_Y-T)/2,i=S+b,E=l+L;n.push(`; Centered on bed ${e.BED_SIZE_X}x${e.BED_SIZE_Y} mm`),n.push(`; Base bbox origin: X${S.toFixed(2)} Y${l.toFixed(2)}`),n.push(`; Pattern origin:   X${i.toFixed(2)} Y${E.toFixed(2)}`),n.push(`; Left label area:  ${b.toFixed(2)} mm, Bottom label margin: ${L.toFixed(2)} mm`),n.push("");const R=e.FIRST_LAYER_Z,M=R+e.LAYER_HEIGHT;if(n.push(f({z:R,f:e.TRAVEL_SPEED*60,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),Re(n,e,{baseX0:S,baseY0:l,originX:i,originY:E,leftLabelArea:b,bottomLabelMargin:L,patternWidth:c,patternHeight:u,z:R}),fe(n,e,{z:R,originX:i,originY:E,rows:e.ROWS,cols:e.COLS,rowBlockHeight:_,patternWidth:c}),Le(n,e,{z:R,originX:i,originY:E,rows:e.ROWS,cols:e.COLS,rowBlockHeight:_}),e.NUM_DOE_LAYERS>=2){const P=Number.isFinite(e.PRINT_ACCEL)?e.PRINT_ACCEL:"",D=Number.isFinite(e.RETRACT_ACCEL)?e.RETRACT_ACCEL:"",x=Number.isFinite(e.TRAVEL_ACCEL)?e.TRAVEL_ACCEL:"";if((P!==""||D!==""||x!=="")&&(n.push(""),n.push(`M204 P${P} R${D} T${x}`),n.push("")),Number.isFinite(e.FAN_SPEED)){const y=Math.round(e.FAN_SPEED/100*255);n.push(`M106 S${y} ; Normal fan speed ${e.FAN_SPEED}%`),n.push("")}}e.NUM_DOE_LAYERS>=1&&(n.push(""),n.push("; --- Printing labels for distances and speeds on layer 2 ---"),n.push("G92 E0 ; reset extruder position"),n.push(f({z:M,f:e.TRAVEL_SPEED*60,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),Ae(n,e,{originX:i,originY:E,baseX0:S,baseY0:l,rowBlockHeight:_,distLevels:A,speedLevels:p,rowFontSize:e.ROW_FONT_SIZE,speedFontSize:e.SPEED_FONT_SIZE,labelGapX:I,bottomLabelMargin:L,zLabel:M}),n.push(""),n.push(`; === DOE Pattern Layer 1/${e.NUM_DOE_LAYERS} at Z=${M.toFixed(3)}, speed=${e.PRINT_SPEED}mm/s ===`),ee(n,e,{z:M,originX:i,originY:E,rows:e.ROWS,cols:e.COLS,distances:A,speeds:p,rowBlockHeight:_,patternWidth:c,printSpeed:e.PRINT_SPEED}));for(let P=1;P<e.NUM_DOE_LAYERS;P++){const D=M+P*e.LAYER_HEIGHT;n.push(""),n.push(`; === DOE Pattern Layer ${P+1}/${e.NUM_DOE_LAYERS} at Z=${D.toFixed(3)}, speed=${e.PRINT_SPEED}mm/s ===`),n.push("G92 E0 ; reset extruder position"),ee(n,e,{z:D,originX:i,originY:E,rows:e.ROWS,cols:e.COLS,distances:A,speeds:p,rowBlockHeight:_,patternWidth:c,printSpeed:e.PRINT_SPEED})}const N=R+(e.NUM_DOE_LAYERS-1)*e.LAYER_HEIGHT,G=Z(e.AVG_RETRACT_DIST,e.AVG_RETRACT_SPEED,e.Z_HOP,N,e.TRAVEL_SPEED);return n.push(""),n.push("; Final retraction"),n.push(G.retract),d&&(n.push(""),n.push(d)),n.join(`
`)+`
`}function K(t,e,r,n,s,o,a){const d=Z(a.AVG_RETRACT_DIST,a.AVG_RETRACT_SPEED,a.Z_HOP,o,a.TRAVEL_SPEED),A=a.TEXT_PRINT_SPEED*60,p=a.TRAVEL_SPEED*60,c=a.E_PER_MM;let _=r,u=null,I=null;for(const F of e){if(F===" "){_+=$*s;continue}const h=pe[F];if(!h){_+=$*s;continue}for(const b of h){const[[L,m],[T,S]]=b,l=_+L*s,i=n+m*s,E=_+T*s,R=n+S*s;(u===null||I===null||Math.abs(l-u)>.001||Math.abs(i-I)>.001)&&(t.push("; Label retract before travel"),t.push(d.retract),t.push(f({x:l,y:i,f:p,bedX:a.BED_SIZE_X,bedY:a.BED_SIZE_Y})),t.push("; Label deretract before stroke"),t.push(d.deretract));const G=Math.hypot(E-l,R-i)*c;t.push(f({x:E,y:R,e:G,f:A,bedX:a.BED_SIZE_X,bedY:a.BED_SIZE_Y})),u=E,I=R}_+=$*s}}function Re(t,e,r){const{baseX0:n,baseY0:s,originX:o,originY:a,leftLabelArea:d,bottomLabelMargin:A,patternWidth:p,patternHeight:c,z:_}=r;t.push(`; --- L-shaped label base at Z=${_.toFixed(3)} ---`);const u=e.FIRST_LAYER_SPEED*60,I=e.TRAVEL_SPEED*60,F=e.EXTRUSION_WIDTH,h=e.E_PER_MM,b=d,L=n,m=p,T=d,S=n,l=s,i=e.EXTRUSION_WIDTH,E=n,R=s,M=o+p,N=a+c,G=o-i,P=a-i;t.push(`; L-shape perimeter for adhesion (offset by ${i.toFixed(3)}mm from grid)`),t.push(f({x:E,y:R,z:_,f:I,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y}));let D,x;D=M-E,x=D*h,t.push(f({x:M,y:R,e:x,f:u,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),D=P-R,x=D*h,t.push(f({x:M,y:P,e:x,f:u,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),D=M-G,x=D*h,t.push(f({x:G,y:P,e:x,f:u,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),D=N-P,x=D*h,t.push(f({x:G,y:N,e:x,f:u,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),D=G-E,x=D*h,t.push(f({x:E,y:N,e:x,f:u,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),D=N-R,x=D*h,t.push(f({x:E,y:R,e:x,f:u,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y}));function y(C,H,O,W,de){if(O<=0||W<=0)return;t.push(`; ${de}: X${C.toFixed(3)} Y${H.toFixed(3)} W${O.toFixed(3)} H${W.toFixed(3)}`),t.push(f({x:C,y:H,z:_,f:I,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y}));const Ee=Math.round(W/F);for(let B=0;B<Ee;B++){const k=H+B*F,j=B%2===0?C:C+O,J=B%2===0?C+O:C;t.push(f({x:j,y:k,f:I,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y}));const ue=Math.abs(J-j)*h;t.push(f({x:J,y:k,e:ue,f:u,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y}))}}const X=Math.floor((A-2*i)/F)*F,Y=l+i+X,w=a+c-Y,le=Math.ceil(w/F)*F,ae=T+m-2*i;y(S+i,l+i,ae,X,"L-bottom fill (with corner)"),y(L+i,Y,b-2*i,le,"L-left fill")}function fe(t,e,r){const{z:n,originX:s,originY:o,rows:a,cols:d,rowBlockHeight:A,patternWidth:p}=r;t.push(`; --- Grid frame layer at Z=${n.toFixed(3)} ---`);const c=e.FIRST_LAYER_SPEED*60,_=e.TRAVEL_SPEED*60,u=e.E_PER_MM,I=a*A-e.ROW_GAP+e.EXTRUSION_WIDTH,F=e.SEGMENT_LENGTH+e.TRAVEL_LENGTH,h=s,b=s+p,L=o,m=o+I,T=Z(e.AVG_RETRACT_DIST,e.AVG_RETRACT_SPEED,e.Z_HOP,n,e.TRAVEL_SPEED);t.push("; Grid frame: outer rectangle"),t.push("; Grid retract before travel to outer start"),t.push(T.retract),t.push(f({x:h,y:L,f:_,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),t.push("; Grid deretract before outer rectangle"),t.push(T.deretract);let S,l;S=b-h,l=S*u,t.push(f({x:b,y:L,e:l,f:c,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),S=m-L,l=S*u,t.push(f({x:b,y:m,e:l,f:c,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),S=b-h,l=S*u,t.push(f({x:h,y:m,e:l,f:c,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),S=m-L,l=S*u,t.push(f({x:h,y:L,e:l,f:c,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),t.push("; Grid frame: vertical lines at segment starts and ends");for(let i=0;i<=d;i++){const E=s+i*F;if(t.push(`; Grid vertical line at segment ${i} start (X=${E.toFixed(3)})`),t.push(T.retract),t.push(f({x:E,y:L,f:_,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),t.push(T.deretract),S=m-L,l=S*u,t.push(f({x:E,y:m,e:l,f:c,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),i<d){const R=s+i*F+e.SEGMENT_LENGTH;t.push(`; Grid vertical line at segment ${i} end (X=${R.toFixed(3)})`),t.push(T.retract),t.push(f({x:R,y:L,f:_,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),t.push(T.deretract),S=m-L,l=S*u,t.push(f({x:R,y:m,e:l,f:c,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y}))}}t.push("; Grid frame: horizontal lines between rows");for(let i=1;i<a;i++){const E=o+i*A;t.push("; Grid retract before horizontal travel"),t.push(T.retract),t.push(f({x:h,y:E,f:_,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),t.push("; Grid deretract before horizontal line"),t.push(T.deretract),S=b-h,l=S*u,t.push(f({x:b,y:E,e:l,f:c,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y}))}}function Le(t,e,r){const{z:n,originX:s,originY:o,rows:a,cols:d,rowBlockHeight:A}=r;t.push(`; --- DOE vertical strips (only where extrusion occurs) at Z=${n.toFixed(3)} ---`);const p=e.FIRST_LAYER_SPEED*60,c=e.TRAVEL_SPEED*60,_=e.E_PER_MM,u=e.EXTRUSION_WIDTH;e.EXTRUSION_WIDTH;const I=Z(e.AVG_RETRACT_DIST,e.AVG_RETRACT_SPEED,e.Z_HOP,n,e.TRAVEL_SPEED),F=a*A-e.ROW_GAP+e.EXTRUSION_WIDTH,h=e.SEGMENT_LENGTH+e.TRAVEL_LENGTH;for(let l=0;l<d;l++){const E=s+l*h,R=e.SEGMENT_LENGTH,M=F,N=o;t.push(`; Strip for column ${l+1}/${d} segment area`);const G=Math.round(M/u);for(let P=0;P<G;P++){const D=N+P*u,x=P%2;P===0&&l===0?(t.push("; Strip retract before first travel"),t.push(I.retract)):P===0&&(t.push("; Strip retract before travel to next strip"),t.push(I.retract));const y=x===0?E:E+R,X=x===0?E+R:E;t.push(f({x:y,y:D,f:c,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),P===0&&(t.push("; Strip deretract before printing"),t.push(I.deretract));const Y=Math.abs(X-y)*_;t.push(f({x:X,y:D,e:Y,f:p,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y}))}}const b=s+d*h,L=e.SEGMENT_LENGTH,m=F,T=o;t.push("; Final strip after all columns");const S=Math.round(m/u);for(let l=0;l<S;l++){const i=T+l*u,E=l%2;l===0&&(t.push("; Final strip retract before travel"),t.push(I.retract));const R=E===0?b:b+L,M=E===0?b+L:b;t.push(f({x:R,y:i,f:c,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),l===0&&(t.push("; Final strip deretract before printing"),t.push(I.deretract));const G=Math.abs(M-R)*_;t.push(f({x:M,y:i,e:G,f:p,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y}))}}function ee(t,e,r){const{z:n,originX:s,originY:o,rows:a,cols:d,distances:A,speeds:p,rowBlockHeight:c,patternWidth:_,printSpeed:u}=r;t.push(`; --- DOE layer at Z=${n.toFixed(3)} ---`);const I=u*60,F=e.TRAVEL_SPEED*60,h=e.E_PER_MM,b=e.EXTRUSION_WIDTH,L=Z(e.AVG_RETRACT_DIST,e.AVG_RETRACT_SPEED,e.Z_HOP,n,e.TRAVEL_SPEED);for(let m=0;m<a;m++){const T=A[m],S=o+m*c+b;t.push(`; ===== Distance row ${m+1}/${a}, dist=${T.toFixed(3)}mm =====`);let l=s;for(let i=0;i<e.LINES_PER_PARAM;i++){const E=i%2===0?1:-1,R=S+i*e.EXTRUSION_WIDTH;i===0&&(l=s),i===0&&m===0&&(t.push("; DOE retract before first travel"),t.push(L.retract)),t.push(f({x:l,y:R,z:n,f:F,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),i===0&&m===0&&(t.push("; DOE deretract before first line"),t.push(L.deretract)),t.push(`; Row ${m+1}/${a}, repetition ${i+1}/${e.LINES_PER_PARAM}, dist=${T.toFixed(3)}mm, dir=${E>0?"L->R":"R->L"}`);const M=E>0?[...Array(d).keys()]:[...Array(d).keys()].reverse();for(const D of M){const x=p[D],y=Se(T,x,e.Z_HOP,n,e.TRAVEL_SPEED);t.push(`;   Col ${D+1}/${d}, speed=${x.toFixed(1)}mm/s`);let X=l+E*e.SEGMENT_LENGTH,Y=Math.abs(X-l)*h;t.push(f({x:X,y:R,e:Y,f:I,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),l=X,t.push(y.retract);let w=l+E*e.TRAVEL_LENGTH;t.push(f({x:w,y:R,f:F,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),l=w,t.push(y.deretract)}t.push(";   Final normal print section at end of repetition line");const N=l+E*e.SEGMENT_LENGTH,P=Math.abs(N-l)*h;t.push(f({x:N,y:R,e:P,f:I,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),l=N}}}function Ae(t,e,r){const{originX:n,originY:s,baseX0:o,baseY0:a,rowBlockHeight:d,distLevels:A,speedLevels:p,rowFontSize:c,speedFontSize:_,labelGapX:u,bottomLabelMargin:I,zLabel:F}=r;A.forEach((L,m)=>{const T=L.toFixed(2)+"mm",S=T.length*$*c,i=s+m*d+d/2-c/2,E=n-u-S,R=o+e.DIST_LABEL_PAD,M=Math.max(E,R);t.push(`; Text label for distance row ${m+1}: ${T}`),K(t,T,M,i,c,F,e)});const h=e.SEGMENT_LENGTH+e.TRAVEL_LENGTH,b=a+(I-_)/2;p.forEach((L,m)=>{const T=L.toFixed(0)+"mm/s",S=T.length*$*_,E=n+m*h+e.SEGMENT_LENGTH+e.TRAVEL_LENGTH/2-S/2;t.push(`; Text label for speed col ${m+1}: ${T}`),K(t,T,E,b,_,F,e)})}const z={},re={};let V=!1;async function Ie(){if(!V)try{const t=await fetch("./presets/manifest.json");if(!t.ok)throw new Error(`Failed to load manifest: ${t.status}`);const e=await t.json();for(const r of e)try{const n=await fetch(`./presets/${r.file}`);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const s=await n.json();z[r.id]=s,re[r.id]=r}catch(n){console.error(`Failed to load preset ${r.id}:`,n)}V=!0}catch(t){console.error("Failed to load manifest:",t)}}async function De(){V||await Ie()}function se(t){return z[t]||null}function be(){return Object.keys(z)}function oe(t){const e=re[t];return e?e.material?`${e.name} - ${e.material}`:e.name:t}function ie(){const t=p=>document.getElementById(p),e=(p,c,_)=>{const u=t(p)||c&&t(c);if(!u)return _;const I=u.value;return I===""||I===void 0?_:Number(I)},r=(p,c,_)=>{const u=e(p,c,_);return Number.isNaN(u)?_:Math.trunc(u)},n=e("retractDist",null,null),s=e("minDist",null,n),o=e("maxDist",null,n),a=e("retractSpeed",null,null),d=e("minSpeed",null,a),A=e("maxSpeed",null,a);return{bedX:e("bedX",null,220),bedY:e("bedY",null,220),bedTemp:e("bedTemp",null,60),minDist:s,maxDist:o,hotendTemp:e("hotendTemp",null,210),minSpeed:d,maxSpeed:A,zHop:e("zHop",null,0),flowFactor:e("flowFactor",null,1),firstLayerFanSpeed:e("firstLayerFanSpeed",null,0),fanSpeed:e("fanSpeed",null,100),firstLayerSpeed:e("firstLayerSpeed",null,30),printSpeed:e("printSpeed",null,50),travelSpeed:e("travelSpeed",null,150),printAccel:e("printAccel",null,1500),retractAccel:e("retractAccel",null,2500),travelAccel:e("travelAccel",null,5e3),layerHeight:e("layerHeight",null,.2),pressureAdvance:function(){const p=t("pressureAdvance");return p?p.value===""?null:Number(p.value):null}(),firstLayerZ:e("firstLayerZ",null,.2),textSpeed:e("textSpeed",null,20),rowFontSize:e("rowFontSize",null,3),speedFontSize:e("speedFontSize",null,3),extrusionWidth:e("extrusionWidth",null,.44),rowGap:e("rowGap",null,1),margin:e("margin",null,5),distLabelPad:e("distLabelPad",null,1),linesPerParam:r("linesPerParam","doeLines",12),rows:r("rows","doeRows",5),cols:r("cols","doeColumns",5),segLen:e("segLen","doeSegments",15),travelLen:e("travelLen",null,15),numLayers:r("numLayers",null,5),firstLayerPrintAccel:function(){const p=e("firstLayerPrintAccel",null,null);return p===null?null:p}(),startGcode:(document.getElementById("startGcode")||{value:""}).value,endGcode:(document.getElementById("endGcode")||{value:""}).value,presetName:(t("presetName")||{value:""}).value,presetDescription:(t("presetDescription")||{value:""}).value}}function U(t){const e=(r,n,s)=>{const o=document.getElementById(r)||n&&document.getElementById(n);o&&(o.value=s==null?"":String(s))};t.bedX!==void 0&&e("bedX",null,t.bedX),t.bedY!==void 0&&e("bedY",null,t.bedY),t.bedTemp!==void 0&&e("bedTemp",null,t.bedTemp),t.minDist!==void 0&&e("minDist","retractDist",t.minDist),t.maxDist!==void 0&&e("maxDist",null,t.maxDist),t.hotendTemp!==void 0&&e("hotendTemp",null,t.hotendTemp),t.minSpeed!==void 0&&e("minSpeed","retractSpeed",t.minSpeed),t.maxSpeed!==void 0&&e("maxSpeed",null,t.maxSpeed),t.zHop!==void 0&&e("zHop",null,t.zHop),t.flowFactor!==void 0&&e("flowFactor",null,t.flowFactor),t.firstLayerFanSpeed!==void 0&&e("firstLayerFanSpeed",null,t.firstLayerFanSpeed),t.fanSpeed!==void 0&&e("fanSpeed",null,t.fanSpeed),t.firstLayerSpeed!==void 0&&e("firstLayerSpeed",null,t.firstLayerSpeed),t.printSpeed!==void 0&&e("printSpeed",null,t.printSpeed),t.travelSpeed!==void 0&&e("travelSpeed",null,t.travelSpeed),t.printAccel!==void 0&&e("printAccel",null,t.printAccel),t.retractAccel!==void 0&&e("retractAccel",null,t.retractAccel),t.travelAccel!==void 0&&e("travelAccel",null,t.travelAccel),t.layerHeight!==void 0&&e("layerHeight",null,t.layerHeight),t.pressureAdvance!==void 0&&e("pressureAdvance",null,t.pressureAdvance),t.firstLayerZ!==void 0&&e("firstLayerZ",null,t.firstLayerZ),t.textSpeed!==void 0&&e("textSpeed",null,t.textSpeed),t.rowFontSize!==void 0&&e("rowFontSize",null,t.rowFontSize),t.speedFontSize!==void 0&&e("speedFontSize",null,t.speedFontSize),t.extrusionWidth!==void 0&&e("extrusionWidth",null,t.extrusionWidth),t.rowGap!==void 0&&e("rowGap",null,t.rowGap),t.margin!==void 0&&e("margin",null,t.margin),t.distLabelPad!==void 0&&e("distLabelPad",null,t.distLabelPad),t.linesPerParam!==void 0&&e("linesPerParam","doeLines",t.linesPerParam),t.rows!==void 0&&e("rows","doeRows",t.rows),t.cols!==void 0&&e("cols","doeColumns",t.cols),t.segLen!==void 0&&e("segLen","doeSegments",t.segLen),t.travelLen!==void 0&&e("travelLen",null,t.travelLen),t.numLayers!==void 0&&e("numLayers",null,t.numLayers),t.firstLayerPrintAccel!==void 0&&e("firstLayerPrintAccel",null,t.firstLayerPrintAccel),t.startGcode!==void 0&&e("startGcode",null,t.startGcode),t.endGcode!==void 0&&e("endGcode",null,t.endGcode),t.presetName!==void 0&&e("presetName",null,t.presetName),t.presetDescription!==void 0&&e("presetDescription",null,t.presetDescription)}function Pe(){const t=document.getElementById("preset-select");t.innerHTML='<option value="">-- Select a printer --</option>',be().forEach(e=>{const r=oe(e),n=document.createElement("option");n.value=e,n.textContent=r,t.appendChild(n)})}function Fe(){const t=document.getElementById("preset-select"),e=document.getElementById("preset-status"),r=t.value;if(!r){e.textContent="";return}const n=se(r);if(!n){e.textContent="Preset not found",e.style.color="#ef4444";return}U(n);const s=n.name||n.presetName,o=n.description||n.presetDescription;s&&(document.getElementById("presetName").value=s),o&&(document.getElementById("presetDescription").value=o),v(),e.textContent=`Loaded: ${s||"Preset"}`,e.style.color="#059669"}function xe(t){const e=document.getElementById("preset-status"),r=t.target.files[0];if(!r)return;const n=new FileReader;n.onload=function(s){try{const o=JSON.parse(s.target.result);U(o);const a=o.name||o.presetName,d=o.description||o.presetDescription;a&&(document.getElementById("presetName").value=a),v(),d&&(document.getElementById("presetDescription").value=d),e.textContent=`Loaded: ${a||"Custom settings"}`,e.style.color="#059669"}catch(o){e.textContent="Error parsing JSON: "+o.message,e.style.color="#ef4444",console.error(o)}},n.onerror=function(){e.textContent="Error reading file",e.style.color="#ef4444"},n.readAsText(r),t.target.value=""}function v(){var h,b,L,m,T,S,l;const t=parseFloat(((h=document.getElementById("minDist"))==null?void 0:h.value)||.2),e=parseFloat(((b=document.getElementById("maxDist"))==null?void 0:b.value)||1.2),r=parseFloat(((L=document.getElementById("minSpeed"))==null?void 0:L.value)||10),n=parseFloat(((m=document.getElementById("maxSpeed"))==null?void 0:m.value)||100),s=parseFloat(((T=document.getElementById("retractAccel"))==null?void 0:T.value)||2500),o=parseInt(((S=document.getElementById("doeRows"))==null?void 0:S.value)||5),a=parseInt(((l=document.getElementById("doeColumns"))==null?void 0:l.value)||5),d=o>1?((e-t)/(o-1)).toFixed(2):0,A=a>1?((n-r)/(a-1)).toFixed(1):0,p=2*s*e,c=Math.sqrt(p),_=c<n,u=document.getElementById("distIncrement"),I=document.getElementById("speedIncrement"),F=document.getElementById("realisticEndSpeed");if(document.getElementById("doeInfoBox"),u&&(u.textContent=d),I&&(I.textContent=A),F){F.textContent=Math.round(c);const i=document.getElementById("realisticEndSpeedContainer");i&&(_?(i.style.backgroundColor="#ffcccc",i.style.padding="2px 6px",i.style.borderRadius="3px",i.style.border="1px solid #cc0000"):(i.style.backgroundColor="transparent",i.style.padding="0",i.style.border="none"))}}function Me(){const t=document.getElementById("output"),e=document.getElementById("status");try{e.textContent="Generating…",e.classList.remove("error");const r=ie(),n=Te(r);t.value=n,e.textContent="G-code generated. You can download it now.",document.getElementById("download-btn").disabled=!1}catch(r){e.textContent="Error: "+r.message,e.classList.add("error"),document.getElementById("download-btn").disabled=!0,console.error(r)}}function ye(){const t=document.getElementById("output").value;if(!t.trim())return;const e=new Blob([t],{type:"text/plain"}),r=URL.createObjectURL(e),n=document.createElement("a");n.href=r,n.download=he(),document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(r)}function Ne(){const t=ie(),e=t.presetName||"untitled",r=new Date,n=`${r.getFullYear()}${String(r.getMonth()+1).padStart(2,"0")}${String(r.getDate()).padStart(2,"0")}-${String(r.getHours()).padStart(2,"0")}${String(r.getMinutes()).padStart(2,"0")}`,s=JSON.stringify(t,null,2),o=new Blob([s],{type:"application/json"}),a=URL.createObjectURL(o),d=document.createElement("a");d.href=a;const A=e.replace(/\s+/g,"_").toLowerCase();d.download=`${A}_${n}.json`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(a)}async function Ge(){await De();const t=se("default");if(t){U(t);const s=document.getElementById("preset-select");s&&(s.value="default");const o=document.getElementById("preset-status");o&&(o.textContent=`Loaded: ${oe("default")}`)}const e=document.getElementById("startGcode"),r=document.getElementById("endGcode");e&&!e.value&&(e.value=te),r&&!r.value&&(r.value=ne),Pe(),document.getElementById("load-preset-btn").addEventListener("click",Fe),document.getElementById("generate-btn").addEventListener("click",Me),document.getElementById("download-btn").addEventListener("click",ye),document.getElementById("download-json-btn").addEventListener("click",Ne),document.getElementById("upload-json-input").addEventListener("change",xe),["minDist","maxDist","minSpeed","maxSpeed","doeRows","doeColumns","retractAccel"].forEach(s=>{const o=document.getElementById(s);o&&(o.addEventListener("input",v),o.addEventListener("change",v))}),v()}window.addEventListener("DOMContentLoaded",Ge);
