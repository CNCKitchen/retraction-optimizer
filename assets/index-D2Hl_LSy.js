(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function r(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=r(o);fetch(o.href,s)}})();const B=.9,ue={0:[[[.1,.1],[.1,.9]],[[.1,.9],[.7,.9]],[[.7,.9],[.7,.1]],[[.7,.1],[.1,.1]]],1:[[[.4,.1],[.4,.9]]],2:[[[.1,.9],[.7,.9]],[[.7,.9],[.7,.5]],[[.7,.5],[.1,.5]],[[.1,.5],[.1,.1]],[[.1,.1],[.7,.1]]],3:[[[.1,.9],[.7,.9]],[[.7,.9],[.7,.1]],[[.1,.1],[.7,.1]],[[.1,.5],[.7,.5]]],4:[[[.1,.9],[.1,.5]],[[.1,.5],[.7,.5]],[[.7,.9],[.7,.1]]],5:[[[.7,.9],[.1,.9]],[[.1,.9],[.1,.5]],[[.1,.5],[.7,.5]],[[.7,.5],[.7,.1]],[[.1,.1],[.7,.1]]],6:[[[.7,.9],[.1,.9]],[[.1,.9],[.1,.1]],[[.1,.1],[.7,.1]],[[.7,.1],[.7,.5]],[[.1,.5],[.7,.5]]],7:[[[.1,.9],[.7,.9]],[[.7,.9],[.7,.1]]],8:[[[.1,.1],[.1,.9]],[[.7,.1],[.7,.9]],[[.1,.1],[.7,.1]],[[.1,.5],[.7,.5]],[[.1,.9],[.7,.9]]],9:[[[.1,.9],[.7,.9]],[[.1,.5],[.7,.5]],[[.7,.9],[.7,.1]],[[.1,.9],[.1,.5]]],".":[[[.3,.1],[.5,.1]]],"-":[[[.1,.5],[.7,.5]]]},K=String.raw`M73 P0 R19
M73 Q0 S21
M201 X10000 Y10000 Z400 E5000 ; sets maximum accelerations, mm/sec^2
M203 X350 Y350 Z12 E100 ; sets maximum feedrates, mm / sec
M204 P7000 R2500 T7000 ; sets acceleration (P, T) and retract acceleration (R), mm/sec^2
M205 X10.00 Y10.00 Z2.00 E10.00 ; sets the jerk limits, mm/sec
M205 S0 T0 ; sets the minimum extruding and travel feed rate, mm/sec

M486 S0
M486 AShape-Box
M486 S-1

;TYPE:Custom
M17 ; enable steppers
M862.1 P0.4 A0 F1 ; nozzle check
M862.3 P "COREONE" ; printer model check
M862.5 P2 ; g-code level check
M862.6 P"Input shaper" ; FW feature check
M115 U6.3.4+10511

M555 X112.5 Y93.5 W32 H29

G90 ; use absolute coordinates
M83 ; extruder relative mode

M140 S[bed_temperature] ; set bed temp

M109 R170 ; wait for temp

M84 E ; turn off E motor

G28 ; home all without mesh bed level

M141 S20 ; set nominal chamber temp

M106 S70
G0 Z40 F10000
M104 T0 S170
M190 R[bed_temperature] ; wait for bed temp
M107

G29 G ; absorb heat

M109 R170 ; wait for MBL temp

M302 S155 ; lower cold extrusion limit to 155C

G1 E-2 F2400 ; retraction

M84 E ; turn off E motor

G29 P9 X208 Y-2.5 W32 H4

;
; MBL
;
M84 E ; turn off E motor
G29 P1 ; invalidate mbl & probe print area
G29 P1 X150 Y0 W100 H20 C ; probe near purge place
G29 P3.2 ; interpolate mbl probes
G29 P3.13 ; extrapolate mbl outside probe area
G29 A ; activate mbl

; prepare for purge
M104 S[hotend_temperature]
G0 X249 Y-2.5 Z15 F4800 ; move away and ready for the purge
M109 S[hotend_temperature]

G92 E0
M569 S0 E ; set spreadcycle mode for extruder

M591 S0 ; disable stuck detection

;
; Extrude purge line
;
G92 E0 ; reset extruder position
G1 E2 F2400 ; deretraction after the initial one
G0 E5 X235 Z0.2 F500 ; purge
G0 X225 E4 F500 ; purge
G0 X215 E4 F650 ; purge
G0 X205 E4 F800 ; purge
G0 X202 Z0.05 F8000 ; wipe, move close to the bed
M73 P1 R19
G0 X199 Z0.2 F8000 ; wipe, move quickly away from the bed

M591 R ; restore stuck detection

G92 E0
M221 S100 ; set flow to 100%
G21 ; set units to millimeters
G90 ; use absolute coordinates
M83 ; use relative distances for extrusion
M572 S0.036 ; Filament gcode

M142 S36 ; set heatbreak target temp
M107`,ee=String.raw`M107
;TYPE:Custom
; Filament-specific end gcode
G1 Z26 F720 ; Move print head up
M104 S0 ; turn off temperature
M140 S0 ; turn off heatbed
M141 S0 ; disable chamber control
M107 ; turn off fan
G1 X242 Y211 F10200 ; park
G4 ; wait
M572 S0 ; reset PA
M84 X Y E ; disable motors
; max_layer_z = 25
M73 P100 R0
M73 Q100 S0`;function J(t,e,r){if(t<=1)return[e];const n=(r-e)/(t-1),o=[];for(let s=0;s<t;s++)o.push(e+s*n);return o}function Ee(t){const e=t/2;return Math.PI*e*e}function ce(t,e,r){return t*e*.9/r}function pe(t,e,r,n){if(t!=null&&(t<0||t>r))throw new Error(`G-code X move ${t.toFixed(3)} is outside bed [0, ${r}]`);if(e!=null&&(e<0||e>n))throw new Error(`G-code Y move ${e.toFixed(3)} is outside bed [0, ${n}]`)}function f({x:t=null,y:e=null,z:r=null,e:n=null,f:o=null,bedX:s,bedY:l}){pe(t,e,s,l);const d=["G1"];return t!=null&&d.push(`X${t.toFixed(3)}`),e!=null&&d.push(`Y${e.toFixed(3)}`),r!=null&&d.push(`Z${r.toFixed(3)}`),n!=null&&d.push(`E${n.toFixed(5)}`),o!=null&&d.push(`F${o.toFixed(0)}`),d.join(" ")}function q(t,e,r){return t.replace(/\[bed_temperature\]/g,String(e)).replace(/\[hotend_temperature\]/g,String(r))}function _e(t,e){const r=e*60;return{retract:`G1 E${(-t).toFixed(5)} F${r.toFixed(0)}`,deretract:`G1 E${t.toFixed(5)} F${r.toFixed(0)}`}}function g(t,e){const r=e*60,n=t;return{retract:`G1 E${(-n).toFixed(5)} F${r.toFixed(0)}`,deretract:`G1 E${n.toFixed(5)} F${r.toFixed(0)}`}}function me(){const t=new Date,e=n=>n.toString().padStart(2,"0");return`retraction_doe_test_${`${t.getFullYear()}${e(t.getMonth()+1)}${e(t.getDate())}_${e(t.getHours())}${e(t.getMinutes())}`}.gcode`}function Se(t){const e={BED_SIZE_X:t.bedX,BED_SIZE_Y:t.bedY,MIN_RETRACT_DIST:t.minDist,MAX_RETRACT_DIST:t.maxDist,MIN_RETRACT_SPEED:t.minSpeed,MAX_RETRACT_SPEED:t.maxSpeed,ROWS:t.rows,COLS:t.cols,LINES_PER_PARAM:t.linesPerParam,NUM_DOE_LAYERS:t.numLayers,SEGMENT_LENGTH:t.segLen,TRAVEL_LENGTH:t.travelLen,FLOW_FACTOR:t.flowFactor,BED_TEMP:t.bedTemp,HOTEND_TEMP:t.hotendTemp,FIRST_LAYER_SPEED:t.firstLayerSpeed,PRINT_SPEED:t.printSpeed,TRAVEL_SPEED:t.travelSpeed,PRINT_ACCEL:t.printAccel,RETRACT_ACCEL:t.retractAccel,TRAVEL_ACCEL:t.travelAccel,FIRST_LAYER_PRINT_ACCEL:t.firstLayerPrintAccel,LAYER_HEIGHT:t.layerHeight,FIRST_LAYER_Z:t.firstLayerZ,TEXT_PRINT_SPEED:t.textSpeed,ROW_FONT_SIZE:t.rowFontSize,SPEED_FONT_SIZE:t.speedFontSize,EXTRUSION_WIDTH:t.extrusionWidth,FILAMENT_DIAMETER:1.75,ROW_GAP:t.rowGap,MARGIN:t.margin,DIST_LABEL_PAD:t.distLabelPad,PRESSURE_ADVANCE:t.pressureAdvance};e.FILAMENT_AREA=Ee(e.FILAMENT_DIAMETER);const r=ce(e.EXTRUSION_WIDTH,e.LAYER_HEIGHT,e.FILAMENT_AREA);e.E_PER_MM=r*e.FLOW_FACTOR,e.AVG_RETRACT_DIST=.5*(e.MIN_RETRACT_DIST+e.MAX_RETRACT_DIST),e.AVG_RETRACT_SPEED=.5*(e.MIN_RETRACT_SPEED+e.MAX_RETRACT_SPEED);const n=[];n.push("; Retraction DOE Test"),n.push("; Generated by retraction_doe_generator (Vite + modular)"),n.push(`; Retraction distance: ${e.MIN_RETRACT_DIST}..${e.MAX_RETRACT_DIST} mm`),n.push(`; Retraction speed:    ${e.MIN_RETRACT_SPEED}..${e.MAX_RETRACT_SPEED} mm/s`),n.push(`; Row repetitions (parallel lines per parameter): ${e.LINES_PER_PARAM}`),n.push(`; Flow factor: ${e.FLOW_FACTOR.toFixed(3)}`),n.push("; Always prints: grid frame + L-shaped label base + labels."),n.push("");const o=t.startGcode||K,s=t.endGcode||ee,l=q(o,e.BED_TEMP,e.HOTEND_TEMP).trim(),d=q(s,e.BED_TEMP,e.HOTEND_TEMP).trim();if(l){if(n.push(l),n.push(""),Number.isFinite(e.PRESSURE_ADVANCE)){const X=e.PRESSURE_ADVANCE;n.push(`pressure_advance = ${X}`),n.push(`M572 S${X}`),n.push("")}let I=e.FIRST_LAYER_PRINT_ACCEL!==null&&e.FIRST_LAYER_PRINT_ACCEL!==void 0?e.FIRST_LAYER_PRINT_ACCEL:e.PRINT_ACCEL;const M=Number.isFinite(e.RETRACT_ACCEL)?e.RETRACT_ACCEL:"",y=Number.isFinite(e.TRAVEL_ACCEL)?e.TRAVEL_ACCEL:"";(Number.isFinite(I)||M!==""||y!=="")&&(n.push(`M204 P${I} R${M} T${y}`),n.push(""))}const b=J(e.ROWS,e.MIN_RETRACT_DIST,e.MAX_RETRACT_DIST),p=J(e.COLS,e.MIN_RETRACT_SPEED,e.MAX_RETRACT_SPEED),c=e.COLS*(e.SEGMENT_LENGTH+e.TRAVEL_LENGTH)+e.SEGMENT_LENGTH,u=e.LINES_PER_PARAM*e.EXTRUSION_WIDTH+e.ROW_GAP,E=e.ROWS*u-e.ROW_GAP+e.EXTRUSION_WIDTH,A=1,P=1;let S=0;b.forEach(I=>{const M=(I.toFixed(2)+"mm").length*B*e.ROW_FONT_SIZE;M>S&&(S=M)});const D=S+A+e.DIST_LABEL_PAD,T=Math.max(e.MARGIN,e.SPEED_FONT_SIZE+P),L=D+c+e.MARGIN,R=T+E;if(L>e.BED_SIZE_X+1e-6||R>e.BED_SIZE_Y+1e-6)throw new Error(`Pattern+labels too big for bed: needs ${L.toFixed(2)} x ${R.toFixed(2)} mm, bed is ${e.BED_SIZE_X.toFixed(2)} x ${e.BED_SIZE_Y.toFixed(2)} mm`);const i=(e.BED_SIZE_X-L)/2,a=(e.BED_SIZE_Y-R)/2,_=i+D,h=a+T;n.push(`; Centered on bed ${e.BED_SIZE_X}x${e.BED_SIZE_Y} mm`),n.push(`; Base bbox origin: X${i.toFixed(2)} Y${a.toFixed(2)}`),n.push(`; Pattern origin:   X${_.toFixed(2)} Y${h.toFixed(2)}`),n.push(`; Left label area:  ${D.toFixed(2)} mm, Bottom label margin: ${T.toFixed(2)} mm`),n.push("");const m=e.FIRST_LAYER_Z,F=m+e.LAYER_HEIGHT;if(n.push(f({z:m,f:e.TRAVEL_SPEED*60,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),Te(n,e,{baseX0:i,baseY0:a,originX:_,originY:h,leftLabelArea:D,bottomLabelMargin:T,patternWidth:c,patternHeight:E,z:m}),fe(n,e,{z:m,originX:_,originY:h,rows:e.ROWS,cols:e.COLS,rowBlockHeight:u,patternWidth:c}),n.push(""),n.push(`; === DOE Layer 1/${e.NUM_DOE_LAYERS} at Z=${m.toFixed(3)}, speed=${e.FIRST_LAYER_SPEED}mm/s ===`),H(n,e,{z:m,originX:_,originY:h,rows:e.ROWS,cols:e.COLS,distances:b,speeds:p,rowBlockHeight:u,patternWidth:c,printSpeed:e.FIRST_LAYER_SPEED}),e.NUM_DOE_LAYERS>=2){const I=Number.isFinite(e.PRINT_ACCEL)?e.PRINT_ACCEL:"",M=Number.isFinite(e.RETRACT_ACCEL)?e.RETRACT_ACCEL:"",y=Number.isFinite(e.TRAVEL_ACCEL)?e.TRAVEL_ACCEL:"";(I!==""||M!==""||y!=="")&&(n.push(""),n.push(`M204 P${I} R${M} T${y}`),n.push(""))}e.NUM_DOE_LAYERS>=2&&(n.push(""),n.push("; --- Printing labels for distances and speeds on second layer ---"),he(n,e,{originX:_,originY:h,baseX0:i,baseY0:a,rowBlockHeight:u,distLevels:b,speedLevels:p,rowFontSize:e.ROW_FONT_SIZE,speedFontSize:e.SPEED_FONT_SIZE,labelGapX:A,bottomLabelMargin:T,zLabel:F}),n.push(""),n.push(`; === DOE Layer 2/${e.NUM_DOE_LAYERS} at Z=${F.toFixed(3)}, speed=${e.PRINT_SPEED}mm/s ===`),H(n,e,{z:F,originX:_,originY:h,rows:e.ROWS,cols:e.COLS,distances:b,speeds:p,rowBlockHeight:u,patternWidth:c,printSpeed:e.PRINT_SPEED}));for(let I=2;I<e.NUM_DOE_LAYERS;I++){const M=m+I*e.LAYER_HEIGHT;n.push(""),n.push(`; === DOE Layer ${I+1}/${e.NUM_DOE_LAYERS} at Z=${M.toFixed(3)}, speed=${e.PRINT_SPEED}mm/s ===`),H(n,e,{z:M,originX:_,originY:h,rows:e.ROWS,cols:e.COLS,distances:b,speeds:p,rowBlockHeight:u,patternWidth:c,printSpeed:e.PRINT_SPEED})}const G=g(e.AVG_RETRACT_DIST,e.AVG_RETRACT_SPEED);return n.push(""),n.push("; Final retraction"),n.push(G.retract),d&&(n.push(""),n.push(d)),n.join(`
`)+`
`}function Q(t,e,r,n,o,s,l,d){const b=l.TEXT_PRINT_SPEED*60,p=l.TRAVEL_SPEED*60,c=l.E_PER_MM;let u=r;for(const E of e){if(E===" "){u+=B*o;continue}const A=ue[E];if(!A){u+=B*o;continue}for(const P of A){const[[S,D],[T,L]]=P,R=u+S*o,i=n+D*o,a=u+T*o,_=n+L*o;t.push("; Label retract before travel"),t.push(d.retract),t.push(f({x:R,y:i,z:s,f:p,bedX:l.BED_SIZE_X,bedY:l.BED_SIZE_Y})),t.push("; Label deretract before stroke"),t.push(d.deretract);const m=Math.hypot(a-R,_-i)*c;t.push(f({x:a,y:_,e:m,f:b,bedX:l.BED_SIZE_X,bedY:l.BED_SIZE_Y}))}u+=B*o}}function Te(t,e,r){const{baseX0:n,baseY0:o,originX:s,originY:l,leftLabelArea:d,bottomLabelMargin:b,patternWidth:p,patternHeight:c,z:u}=r;t.push(`; --- L-shaped label base at Z=${u.toFixed(3)} ---`);const E=e.FIRST_LAYER_SPEED*60,A=e.TRAVEL_SPEED*60,P=e.EXTRUSION_WIDTH,S=e.E_PER_MM,D=d,T=n,L=p,R=s,i=o,a=d,_=n,h=o,m=e.EXTRUSION_WIDTH,F=n,G=o,I=s+p,M=l+c,y=s-m,X=l-m;t.push(`; L-shape perimeter for adhesion (offset by ${m.toFixed(3)}mm from grid)`),t.push(f({x:F,y:G,z:u,f:A,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y}));let x,N;x=I-F,N=x*S,t.push(f({x:I,y:G,e:N,f:E,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),x=X-G,N=x*S,t.push(f({x:I,y:X,e:N,f:E,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),x=I-y,N=x*S,t.push(f({x:y,y:X,e:N,f:E,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),x=M-X,N=x*S,t.push(f({x:y,y:M,e:N,f:E,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),x=y-F,N=x*S,t.push(f({x:F,y:M,e:N,f:E,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),x=M-G,N=x*S,t.push(f({x:F,y:G,e:N,f:E,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y}));function w(C,Z,$,O,le){if($<=0||O<=0)return;t.push(`; ${le}: X${C.toFixed(3)} Y${Z.toFixed(3)} W${$.toFixed(3)} H${O.toFixed(3)}`),t.push(f({x:C,y:Z,z:u,f:A,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y}));const de=Math.round(O/P);for(let v=0;v<de;v++){const z=Z+v*P,k=v%2===0?C:C+$,j=v%2===0?C+$:C;t.push(f({x:k,y:z,f:A,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y}));const ae=Math.abs(j-k)*S;t.push(f({x:j,y:z,e:ae,f:E,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y}))}}const Y=Math.floor((b-2*m)/P)*P,oe=Y,U=h+m+Y,se=l+c-U,ie=Math.ceil(se/P)*P;w(_+m,h+m,a-2*m,Y,"L-corner fill"),w(T+m,U,D-2*m,ie,"L-left fill"),w(R,i+m,L-m,oe,"L-bottom fill")}function fe(t,e,r){const{z:n,originX:o,originY:s,rows:l,cols:d,rowBlockHeight:b,patternWidth:p}=r;t.push(`; --- Grid frame layer at Z=${n.toFixed(3)} ---`);const c=e.FIRST_LAYER_SPEED*60,u=e.TRAVEL_SPEED*60,E=e.E_PER_MM,A=l*b-e.ROW_GAP+e.EXTRUSION_WIDTH,P=e.SEGMENT_LENGTH+e.TRAVEL_LENGTH,S=o,D=o+p,T=s,L=s+A,R=g(e.AVG_RETRACT_DIST,e.AVG_RETRACT_SPEED);t.push("; Grid frame: outer rectangle"),t.push("; Grid retract before travel to outer start"),t.push(R.retract),t.push(f({x:S,y:T,z:n,f:u,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),t.push("; Grid deretract before outer rectangle"),t.push(R.deretract);let i,a;i=D-S,a=i*E,t.push(f({x:D,y:T,e:a,f:c,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),i=L-T,a=i*E,t.push(f({x:D,y:L,e:a,f:c,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),i=D-S,a=i*E,t.push(f({x:S,y:L,e:a,f:c,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),i=L-T,a=i*E,t.push(f({x:S,y:T,e:a,f:c,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),t.push("; Grid frame: vertical lines between columns");for(let _=1;_<d;_++){const h=o+_*P;t.push("; Grid retract before vertical travel"),t.push(R.retract),t.push(f({x:h,y:T,z:n,f:u,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),t.push("; Grid deretract before vertical line"),t.push(R.deretract),i=L-T,a=i*E,t.push(f({x:h,y:L,e:a,f:c,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y}))}t.push("; Grid frame: horizontal lines between rows");for(let _=1;_<l;_++){const h=s+_*b;t.push("; Grid retract before horizontal travel"),t.push(R.retract),t.push(f({x:S,y:h,z:n,f:u,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),t.push("; Grid deretract before horizontal line"),t.push(R.deretract),i=D-S,a=i*E,t.push(f({x:D,y:h,e:a,f:c,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y}))}}function H(t,e,r){const{z:n,originX:o,originY:s,rows:l,cols:d,distances:b,speeds:p,rowBlockHeight:c,patternWidth:u,printSpeed:E}=r;t.push(`; --- DOE layer at Z=${n.toFixed(3)} ---`);const A=E*60,P=e.TRAVEL_SPEED*60,S=e.E_PER_MM,D=e.EXTRUSION_WIDTH;for(let T=0;T<l;T++){const L=b[T],R=s+T*c+D;t.push(`; ===== Distance row ${T+1}/${l}, dist=${L.toFixed(3)}mm =====`);let i=o;for(let a=0;a<e.LINES_PER_PARAM;a++){const _=a%2===0?1:-1,h=R+a*e.EXTRUSION_WIDTH;a===0&&(i=o),t.push(f({x:i,y:h,z:n,f:P,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),t.push(`; Row ${T+1}/${l}, repetition ${a+1}/${e.LINES_PER_PARAM}, dist=${L.toFixed(3)}mm, dir=${_>0?"L->R":"R->L"}`);const m=_>0?[...Array(d).keys()]:[...Array(d).keys()].reverse();for(const M of m){const y=p[M],X=_e(L,y);t.push(`;   Col ${M+1}/${d}, speed=${y.toFixed(1)}mm/s`);let x=i+_*e.SEGMENT_LENGTH,w=Math.abs(x-i)*S;t.push(f({x,y:h,e:w,f:A,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),i=x,t.push(X.retract);let Y=i+_*e.TRAVEL_LENGTH;t.push(f({x:Y,y:h,f:P,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),i=Y,t.push(X.deretract)}t.push(";   Final normal print section at end of repetition line");const F=i+_*e.SEGMENT_LENGTH,I=Math.abs(F-i)*S;t.push(f({x:F,y:h,e:I,f:A,bedX:e.BED_SIZE_X,bedY:e.BED_SIZE_Y})),i=F}}}function he(t,e,r){const{originX:n,originY:o,baseX0:s,baseY0:l,rowBlockHeight:d,distLevels:b,speedLevels:p,rowFontSize:c,speedFontSize:u,labelGapX:E,bottomLabelMargin:A,zLabel:P}=r,S=g(e.AVG_RETRACT_DIST,e.AVG_RETRACT_SPEED);b.forEach((L,R)=>{const i=L.toFixed(2)+"mm",a=i.length*B*c,h=o+R*d+d/2-c/2,m=n-E-a,F=s+e.DIST_LABEL_PAD,G=Math.max(m,F);t.push(`; Text label for distance row ${R+1}: ${i}`),Q(t,i,G,h,c,P,e,S)});const D=e.SEGMENT_LENGTH+e.TRAVEL_LENGTH,T=l+(A-u)/2;p.forEach((L,R)=>{const i=L.toFixed(0)+"mm/s",a=i.length*B*u,m=n+R*D+e.SEGMENT_LENGTH+e.TRAVEL_LENGTH/2-a/2;t.push(`; Text label for speed col ${R+1}: ${i}`),Q(t,i,m,T,u,P,e,S)})}const V={},te={};let W=!1;async function Re(){if(!W)try{const t=await fetch("./presets/manifest.json");if(!t.ok)throw new Error(`Failed to load manifest: ${t.status}`);const e=await t.json();for(const r of e)try{const n=await fetch(`./presets/${r.file}`);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=await n.json();V[r.id]=o,te[r.id]=r}catch(n){console.error(`Failed to load preset ${r.id}:`,n)}W=!0}catch(t){console.error("Failed to load manifest:",t)}}async function Le(){W||await Re()}function be(t){return V[t]||null}function Ae(){return Object.keys(V)}function De(t){var e;return((e=te[t])==null?void 0:e.name)||t}function ne(){const t=p=>document.getElementById(p),e=(p,c,u)=>{const E=t(p)||c&&t(c);if(!E)return u;const A=E.value;return A===""||A===void 0?u:Number(A)},r=(p,c,u)=>{const E=e(p,c,u);return Number.isNaN(E)?u:Math.trunc(E)},n=e("retractDist",null,null),o=e("minDist",null,n),s=e("maxDist",null,n),l=e("retractSpeed",null,null),d=e("minSpeed",null,l),b=e("maxSpeed",null,l);return{bedX:e("bedX",null,220),bedY:e("bedY",null,220),bedTemp:e("bedTemp",null,60),minDist:o,maxDist:s,hotendTemp:e("hotendTemp",null,210),minSpeed:d,maxSpeed:b,flowFactor:e("flowFactor",null,1),firstLayerSpeed:e("firstLayerSpeed",null,30),printSpeed:e("printSpeed",null,50),travelSpeed:e("travelSpeed",null,150),printAccel:e("printAccel",null,1500),retractAccel:e("retractAccel",null,2500),travelAccel:e("travelAccel",null,5e3),layerHeight:e("layerHeight",null,.2),pressureAdvance:function(){const p=t("pressureAdvance");return p?p.value===""?null:Number(p.value):null}(),firstLayerZ:e("firstLayerZ",null,.2),textSpeed:e("textSpeed",null,20),rowFontSize:e("rowFontSize",null,3),speedFontSize:e("speedFontSize",null,3),extrusionWidth:e("extrusionWidth",null,.44),rowGap:e("rowGap",null,1),margin:e("margin",null,5),distLabelPad:e("distLabelPad",null,1),linesPerParam:r("linesPerParam","doeLines",12),rows:r("rows","doeRows",5),cols:r("cols","doeColumns",5),segLen:e("segLen","doeSegments",15),travelLen:e("travelLen",null,15),numLayers:r("numLayers",null,5),firstLayerPrintAccel:function(){const p=e("firstLayerPrintAccel",null,null);return p===null?null:p}(),startGcode:(document.getElementById("startGcode")||{value:""}).value,endGcode:(document.getElementById("endGcode")||{value:""}).value,presetName:(t("presetName")||{value:""}).value,presetDescription:(t("presetDescription")||{value:""}).value}}function re(t){const e=(r,n,o)=>{const s=document.getElementById(r)||n&&document.getElementById(n);s&&(s.value=o==null?"":String(o))};t.bedX!==void 0&&e("bedX",null,t.bedX),t.bedY!==void 0&&e("bedY",null,t.bedY),t.bedTemp!==void 0&&e("bedTemp",null,t.bedTemp),t.minDist!==void 0&&e("minDist","retractDist",t.minDist),t.maxDist!==void 0&&e("maxDist",null,t.maxDist),t.hotendTemp!==void 0&&e("hotendTemp",null,t.hotendTemp),t.minSpeed!==void 0&&e("minSpeed","retractSpeed",t.minSpeed),t.maxSpeed!==void 0&&e("maxSpeed",null,t.maxSpeed),t.flowFactor!==void 0&&e("flowFactor",null,t.flowFactor),t.firstLayerSpeed!==void 0&&e("firstLayerSpeed",null,t.firstLayerSpeed),t.printSpeed!==void 0&&e("printSpeed",null,t.printSpeed),t.travelSpeed!==void 0&&e("travelSpeed",null,t.travelSpeed),t.printAccel!==void 0&&e("printAccel",null,t.printAccel),t.retractAccel!==void 0&&e("retractAccel",null,t.retractAccel),t.travelAccel!==void 0&&e("travelAccel",null,t.travelAccel),t.layerHeight!==void 0&&e("layerHeight",null,t.layerHeight),t.pressureAdvance!==void 0&&e("pressureAdvance",null,t.pressureAdvance),t.firstLayerZ!==void 0&&e("firstLayerZ",null,t.firstLayerZ),t.textSpeed!==void 0&&e("textSpeed",null,t.textSpeed),t.rowFontSize!==void 0&&e("rowFontSize",null,t.rowFontSize),t.speedFontSize!==void 0&&e("speedFontSize",null,t.speedFontSize),t.extrusionWidth!==void 0&&e("extrusionWidth",null,t.extrusionWidth),t.rowGap!==void 0&&e("rowGap",null,t.rowGap),t.margin!==void 0&&e("margin",null,t.margin),t.distLabelPad!==void 0&&e("distLabelPad",null,t.distLabelPad),t.linesPerParam!==void 0&&e("linesPerParam","doeLines",t.linesPerParam),t.rows!==void 0&&e("rows","doeRows",t.rows),t.cols!==void 0&&e("cols","doeColumns",t.cols),t.segLen!==void 0&&e("segLen","doeSegments",t.segLen),t.travelLen!==void 0&&e("travelLen",null,t.travelLen),t.numLayers!==void 0&&e("numLayers",null,t.numLayers),t.firstLayerPrintAccel!==void 0&&e("firstLayerPrintAccel",null,t.firstLayerPrintAccel),t.startGcode!==void 0&&e("startGcode",null,t.startGcode),t.endGcode!==void 0&&e("endGcode",null,t.endGcode),t.presetName!==void 0&&e("presetName",null,t.presetName),t.presetDescription!==void 0&&e("presetDescription",null,t.presetDescription)}function Ie(){const t=document.getElementById("preset-select");t.innerHTML='<option value="">-- Select a printer --</option>',Ae().forEach(e=>{const r=De(e),n=document.createElement("option");n.value=e,n.textContent=r,t.appendChild(n)})}function Me(){const t=document.getElementById("preset-select"),e=document.getElementById("preset-status"),r=t.value;if(!r){e.textContent="";return}const n=be(r);if(!n){e.textContent="Preset not found",e.style.color="#ef4444";return}re(n);const o=n.name||n.presetName,s=n.description||n.presetDescription;o&&(document.getElementById("presetName").value=o),s&&(document.getElementById("presetDescription").value=s),e.textContent=`Loaded: ${o||"Preset"}`,e.style.color="#059669"}function Pe(t){const e=document.getElementById("preset-status"),r=t.target.files[0];if(!r)return;const n=new FileReader;n.onload=function(o){try{const s=JSON.parse(o.target.result);re(s);const l=s.name||s.presetName,d=s.description||s.presetDescription;l&&(document.getElementById("presetName").value=l),d&&(document.getElementById("presetDescription").value=d),e.textContent=`Loaded: ${l||"Custom settings"}`,e.style.color="#059669"}catch(s){e.textContent="Error parsing JSON: "+s.message,e.style.color="#ef4444",console.error(s)}},n.onerror=function(){e.textContent="Error reading file",e.style.color="#ef4444"},n.readAsText(r),t.target.value=""}function xe(){const t=document.getElementById("status"),e=document.getElementById("output");try{t.textContent="Generatingâ€¦",t.classList.remove("error");const r=ne(),n=Se(r);e.value=n,t.textContent="G-code generated. You can download it now.",document.getElementById("download-btn").disabled=!1}catch(r){t.textContent="Error: "+r.message,t.classList.add("error"),document.getElementById("download-btn").disabled=!0,console.error(r)}}function Fe(){const t=document.getElementById("output").value;if(!t.trim())return;const e=new Blob([t],{type:"text/plain"}),r=URL.createObjectURL(e),n=document.createElement("a");n.href=r,n.download=me(),document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(r)}function ye(){const t=ne(),e=t.presetName||"untitled",r=new Date,n=`${r.getFullYear()}${String(r.getMonth()+1).padStart(2,"0")}${String(r.getDate()).padStart(2,"0")}-${String(r.getHours()).padStart(2,"0")}${String(r.getMinutes()).padStart(2,"0")}`,o=JSON.stringify(t,null,2),s=new Blob([o],{type:"application/json"}),l=URL.createObjectURL(s),d=document.createElement("a");d.href=l;const b=e.replace(/\s+/g,"_").toLowerCase();d.download=`${b}_${n}.json`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(l)}async function Ne(){await Le();const t=document.getElementById("startGcode"),e=document.getElementById("endGcode");t&&!t.value&&(t.value=K),e&&!e.value&&(e.value=ee),Ie(),document.getElementById("load-preset-btn").addEventListener("click",Me),document.getElementById("generate-btn").addEventListener("click",xe),document.getElementById("download-btn").addEventListener("click",Fe),document.getElementById("download-json-btn").addEventListener("click",ye),document.getElementById("upload-json-input").addEventListener("change",Pe)}window.addEventListener("DOMContentLoaded",Ne);
